<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Chatbot + SoSci Survey</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #fff;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .header {
      width: 100vw;
      height: 260px;
      background: none;
      padding: 0;
      margin: 0;
      position: relative;
    }
    .spline-chatbot {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: none;
      box-shadow: none;
      border-radius: 0;
      display: block;
    }
    .sosci-iframe {
      width: 100vw;
      height: calc(100vh - 260px);
      border: none;
      display: block;
    }
    .chat-popup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 720px;
      max-width: 98vw;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      z-index: 2000;
      min-height: 360px;
      min-width: 480px;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #e6e6f7;
      border-radius: 16px 16px 0 0;
      font-weight: bold;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-size: 17px;
      min-height: 200px;
    }
    .chat-input-area {
      display: flex;
      border-top: 1px solid #eee;
      padding: 12px;
      background: #fafaff;
    }
    #chatInput {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 17px;
      outline: none;
    }
    #sendChat {
      margin-left: 12px;
      padding: 10px 28px;
      border-radius: 8px;
      border: none;
      background: #b3b3e6;
      color: #fff;
      font-weight: bold;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChat:hover {
      background: #8a8ad6;
    }
    @media (max-width: 600px) {
      .header, .sosci-iframe {
        width: 100vw;
      }
      .spline-chatbot {
        width: 100%;
        height: 100%;
      }
    }
  </style>
  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.10.44/build/spline-viewer.js"></script>
</head>
<body>
  <div class="header">
    <div class="spline-chatbot">
      <spline-viewer 
      id="splineBot" 
      url="https://prod.spline.design/TcP4CdVPfRiOUfmZ/scene.splinecode"
      onload="onSplineLoaded(event)">
    </spline-viewer>    
    </div>
  </div>
  <div id="chatPopup" class="chat-popup" style="display:none;">
    <div class="chat-header">
      <span>What can I do for you?</span>
      <button id="closeChat" class="close-btn">&times;</button>
    </div>
    <div class="chat-messages">
    </div>
    <div class="chat-input-area">
      <input id="chatInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendChat">Send</button>
    </div>
  </div>
  <!-- SoSci Survey é—®å· -->
  <iframe class="sosci-iframe" src="https://www.soscisurvey.de/TestWithsurvey/?q=Test"></iframe>

  <script>
  document.getElementById('splineBot').addEventListener('click', function () {
    document.getElementById('chatPopup').style.display = 'flex';
  });

document.getElementById('splineBot').addEventListener('click', async function () {
  // âœ… æ¯æ¬¡æ‰“å¼€ popup æ—¶å¼ºåˆ¶æ–°å»º Thread
  threadId = null; 
  await createThread();
  console.log("âœ… New Thread created:", threadId);

  document.getElementById('chatPopup').style.display = 'flex';
});


  // âœ… Throttle function to limit API calls
  function throttle(func, limit) {
    let lastFunc;
    let lastRan;
    return function (...args) {
      const context = this;
      if (!lastRan) {
        func.apply(context, args);
        lastRan = Date.now();
      } else {
        clearTimeout(lastFunc);
        lastFunc = setTimeout(function () {
          if ((Date.now() - lastRan) >= limit) {
            func.apply(context, args);
            lastRan = Date.now();
          }
        }, limit - (Date.now() - lastRan));
      }
    };
  }

// âœ… Webhook settings (æ›¿æ¢ä¸ºä½ çš„ Webhook)
const SPLINE_WEBHOOK_URL = "https://hooks.spline.design/hShFzXwoRXU";
const AUTH_KEY = "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA";

// âœ… å‘é€åˆ° Spline
async function sendToSpline(x, y) {
  try {
    const res = await fetch(SPLINE_WEBHOOK_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": AUTH_KEY,
        "Accept": "application/json"
      },
      body: JSON.stringify({
        targetX: x,
        targetY: y
      })
    });
    if (!res.ok) {
      console.error("Webhook request failed:", res.statusText);
    } else {
      console.log("âœ… Webhook sent to Spline:", x, y);
    }
  } catch (error) {
    console.error("âŒ Error sending to Spline:", error);
  }
}

// âœ… Throttle function (å…¨å±€åªåˆ›å»ºä¸€æ¬¡)
function throttle(func, limit) {
  let lastRun;
  return function (...args) {
    if (!lastRun || Date.now() - lastRun >= limit) {
      func.apply(this, args);
      lastRun = Date.now();
    }
  };
}
const throttledSend = throttle(sendToSpline, 16); // æ¯ 16ms æ‰§è¡Œä¸€æ¬¡

// ===== Listen to SoSci Messages =====
window.addEventListener("message", function (event) {
  if (!event.data) return;
  console.log("ğŸ“© Message from SoSci:", event.data);

  if (event.data.type === "mouseMove") {
    // Convert to global coordinates (important if needed)
    const iframe = document.querySelector(".sosci-iframe");
    const rect = iframe.getBoundingClientRect();
    const globalX = event.data.x + rect.left;
    const globalY = event.data.y + rect.top;

    // ç›´æ¥ä½¿ç”¨å…¨å±€åæ ‡
    console.log("ğŸ–± Global Position:", globalX, globalY);
    throttledSend(globalX, globalY);
  }
});

console.log("âœ… Parent TooFast Listener Running...");

let lastClickTime = 0;

// âœ… ç›‘å¬æ¥è‡ª SoSci çš„æ¶ˆæ¯
window.addEventListener("message", async function(event) {
  // æ‰“å°æ‰€æœ‰æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
  console.log("ğŸ“© Received message from SoSci:", event.data);

  // åªå¤„ç† nextClicked æ¶ˆæ¯
  if (!event.data || event.data.type !== "nextClicked") return;

  const now = Date.now();
  console.log("âœ… Parent received: nextClicked at", now);

  if (now - lastClickTime < 10000) { // âœ… åˆ¤æ–­é—´éš”æ˜¯å¦å°äº10ç§’
    console.log("âš¡ TooFast triggered! Sending Webhook to Spline...");
    await triggerTooFast();
  }

  lastClickTime = now;
});

// âœ… å‘é€ TooFast Webhook åˆ° Spline
async function triggerTooFast() {
  console.log("â© Sending WebhookTooFast to Spline...");

  try {
    const response = await fetch("https://hooks.spline.design/wRpIXhNtx2M", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA",
        "Accept": "application/json"
      },
      body: JSON.stringify({ Fast: "" }) // âœ… å‚æ•°å¿…é¡»ä¸å›¾ä¸­çš„Webhooksè®¾ç½®ä¸€è‡´
    });

    const text = await response.text();
    console.log("âœ… WebhookTooFast Response Status:", response.status);
    console.log("âœ… WebhookTooFast Response Text:", text);

    if (response.ok) {
      console.log("âœ… WebhookTooFast å·²æˆåŠŸå‘é€ï¼");
    } else {
      console.error("âŒ WebhookTooFast å‘é€å¤±è´¥ï¼çŠ¶æ€ç ï¼š", response.status, text);
    }
  } catch (err) {
    console.error("âŒ WebhookTooFast å‘é€å¼‚å¸¸ï¼š", err);
  }
}

/******************************
 * âœ… OpenAI Assistants Chat Logic (English UI)
 * Put this after all Spline & SoSci code
 ******************************/



// ğŸ‘‰ Replace with your own keys
const ASSISTANT_ID = "asst_87IY5eVsu1vXM4RSr71kykww";  
const OPENAI_PROXY_URL = "https://chatbotsurvey.yuqing.wang"

let threadId = null;        
let questionCount = 0;      
const MAX_QUESTIONS = 20;   // Limit to 20 questions

// âœ… Create Thread (only once)
async function createThread() {
  const res = await fetch(`${OPENAI_PROXY_URL}/v1/threads`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    }
  });
  const data = await res.json();
  threadId = data.id;
  console.log("âœ… Thread created:", threadId);
}

// âœ… Send user message & get reply
async function sendMessageToAssistant(userMessage) {
  if (!threadId) await createThread();
  questionCount++;

  // âœ… Limit check
  if (questionCount > MAX_QUESTIONS) {
    return "âš ï¸ You have reached the maximum of 20 questions. Please continue with the survey.";
  }

  // 1. Add user message
  await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      role: "user",
      content: userMessage
    })
  });

  // 2. Run Assistant
  const runRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ assistant_id: ASSISTANT_ID })
  });
  const runData = await runRes.json();
  console.log("ğŸš€ Run started:", runData.id);


  // 3. Poll until completed
  let status = "in_progress";
  while (status === "in_progress" || status === "queued") {
    await new Promise(r => setTimeout(r, 500)); // å‡å°‘åˆ° 500ms
    const checkRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs/${runData.id}`);
    const checkData = await checkRes.json();
    status = checkData.status;
    console.log("â³ Run status:", status);
  }

  // 4. Get reply
  const msgRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`,);
  const messages = await msgRes.json();
  const assistantMessage = messages.data.find(msg => msg.role === "assistant");
  const reply = assistantMessage ? assistantMessage.content[0].text.value : "âš ï¸ No reply from Assistant.";
  console.log("ğŸ¤– Assistant reply:", reply);
  return reply;
}

// âœ… Bind popup's Send button (already in your popup)
document.getElementById("sendChat").addEventListener("click", async () => {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>ğŸ‘¤ You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>ğŸ¤– Bot:</b> ${reply}</div>`;

  chatBox.scrollTop = chatBox.scrollHeight;
});


// âœ… New: Press Enter to send message
document.getElementById("chatInput").addEventListener("keydown", async (event) => {
  if (event.key === "Enter" && !event.shiftKey) { 
    event.preventDefault();  // Prevent adding a new line
    await handleSendMessage();
  }
});

// âœ… Extracted sending logic into one function (avoid duplicate code)
async function handleSendMessage() {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>ğŸ‘¤ You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>ğŸ¤– Bot:</b> ${reply}</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;
}

// å‘é€ 'Send' Webhook åˆ° Spline
async function sendWebhookToSpline() {
  try {
    const response = await fetch('https://hooks.spline.design/IxDJ6RlBwGQ', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': '35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 'Send': '' })
    });

    if (!response.ok) {
      console.error('âŒ Webhook Send failed:', response.statusText);
    } else {
      console.log('âœ… Webhook Send successfully sent to Spline');
    }
  } catch (error) {
    console.error('âŒ Error sending Webhook Send to Spline:', error);
  }
}

// ç»‘å®š Send æŒ‰é’®
const sendButton = document.getElementById('sendChat');
sendButton.addEventListener('click', async () => {
  await sendWebhookToSpline();
  // å…¶ä»–å‘é€é€»è¾‘...
});

document.getElementById('closeChat').addEventListener('click', function () {
  document.getElementById('chatPopup').style.display = 'none';
});

let robot = null;
let mouseX = 0, mouseY = 0;

function waitForSpline() {
  const splineViewer = document.getElementById('splineBot');

  if (!splineViewer) {
    console.log("âŒ æ²¡æ‰¾åˆ° spline-viewer å…ƒç´ ");
    setTimeout(waitForSpline, 500);
    return;
  }

  if (splineViewer.spline) {
    const splineApp = splineViewer.spline;
    robot = splineApp.findObjectByName('Robot');
    console.log("âœ… æ‰¾åˆ°çš„å¯¹è±¡ï¼š", robot);
    if (robot) {
      animateLookAt(splineApp.THREE);
    } else {
      console.log("âŒ æ²¡æœ‰æ‰¾åˆ°åä¸º Robot çš„å¯¹è±¡ï¼Œè¯·æ£€æŸ¥åå­—");
    }
  } else {
    console.log("â³ ç­‰å¾… Spline åŠ è½½ä¸­...");
    setTimeout(waitForSpline, 500);
  }
}

// âœ… å¯åŠ¨è½®è¯¢
waitForSpline();

function animateLookAt(THREE) {
  function loop() {
    if (robot) {
      const target = new THREE.Vector3(mouseX / 10, -mouseY / 10, 0);
      robot.lookAt(target);
    }
    requestAnimationFrame(loop);
  }
  loop();
}

// âœ… SoSci é¼ æ ‡ç›‘å¬ä¿æŒä¸å˜
window.addEventListener("message", function (event) {
  if (!event.data || event.data.type !== "mouseMove") return;
  const iframe = document.querySelector(".sosci-iframe");
  const rect = iframe.getBoundingClientRect();
  mouseX = event.data.x + rect.left;
  mouseY = event.data.y + rect.top;
});


window.addEventListener("message", function(event) {
  if (event.data?.type === "questionChange") {
    const questionId = event.data.questionId;
    console.log("âœ… Received questionChange:", questionId);

    // Only send webhook for specific questions
    const validIds = ["A101", "A109", "A203", "A404", "A604"];
    if (validIds.includes(questionId)) {
      sendSplineWebhook(questionId);
    }
  }
});

function sendSplineWebhook(questionId) {
  switch (questionId) {
    case "A101":
      fetch("https://hooks.spline.design/FUxKtlrS6bU", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A101": "" })
      })
      .then(() => console.log("ğŸ“¡ Webhook sent: A101"))
      .catch(err => console.error("âŒ A101 webhook failed:", err));
      break;

    case "A109":
      fetch("https://hooks.spline.design/qQ_kyKk6gdk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A109": "" })
      })
      .then(() => console.log("ğŸ“¡ Webhook sent: A109"))
      .catch(err => console.error("âŒ A109 webhook failed:", err));
      break;

    case "A203":
      fetch("https://hooks.spline.design/vWQWEibHcqw", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A203": "" })
      })
      .then(() => console.log("ğŸ“¡ Webhook sent: A203"))
      .catch(err => console.error("âŒ A203 webhook failed:", err));
      break;

    case "A404":
      fetch("https://hooks.spline.design/XiidigihE4U", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A404": "" })
      })
      .then(() => console.log("ğŸ“¡ Webhook sent: A404"))
      .catch(err => console.error("âŒ A404 webhook failed:", err));
      break;

    case "A604":
      fetch("https://hooks.spline.design/mPAI0ZeEE2g", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A604": "" })
      })
      .then(() => console.log("ğŸ“¡ Webhook sent: A604"))
      .catch(err => console.error("âŒ A604 webhook failed:", err));
      break;

    default:
      console.log("âš ï¸ No webhook defined for:", questionId);
  }
}


</script>


</body>
</html> 