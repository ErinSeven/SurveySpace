<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Chatbot + SoSci Survey</title>
  <script>
  (function () {
    try {
      var ua = navigator.userAgent || "";
      var isMobile = /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      var isIPad = /iPad|Tablet/i.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      var uaDataMobile = navigator.userAgentData && navigator.userAgentData.mobile === true;
      var isDesktop = !(isMobile || isIPad || uaDataMobile);
      window.__IS_DESKTOP__ = isDesktop;
      if (!isDesktop) {
        var style = document.createElement('style');
        style.textContent = 'html,body{height:100%} body{margin:0;background:#fff} .__blocked__overlay{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;padding:24px;text-align:center;font-family:system-ui,-apple-system,\'Segoe UI\',Roboto,Helvetica,Arial,sans-serif;color:#222;z-index:2147483647}';
        document.head.appendChild(style);

        function showOverlay() {
          var overlay = document.createElement('div');
          overlay.className = '__blocked__overlay';
          overlay.textContent = 'For the best viewing and interaction experience, please complete this survey on a desktop or laptop computer Thank you for your understanding.';
          document.body.appendChild(overlay);
          if (window.stop) { try { window.stop(); } catch (e) {} }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', showOverlay);
        } else {
          showOverlay();
        }
      }
    } catch (e) {
      // Â¶ÇÊûúÊ£ÄÊµãÂ§±Ë¥•ÔºåÈªòËÆ§ÁªßÁª≠Âä†ËΩΩÔºà‰ª•ÈÅøÂÖçËØØ‰º§Ê°åÈù¢Á´ØÔºâ
    }
  })();
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #fff;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .header {
      width: 100vw;
      height: 260px;
      background: none;
      padding: 0;
      margin: 0;
      position: relative;
    }
    .spline-chatbot {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: none;
      box-shadow: none;
      border-radius: 0;
      display: block;
    }
    .sosci-iframe {
      width: 100vw;
      height: calc(100vh - 260px);
      border: none;
      display: block;
    }
    .iframe-overlay {
      position: fixed;
      left: 0;
      top: 260px; /* match header height */
      width: 100vw;
      height: calc(100vh - 260px);
      background: rgba(211, 211, 230, 0.5); /* #D3D3E6 at 50% */
      z-index: 1500; /* below chat popup (2000), above iframe */
      pointer-events: auto; /* intercept clicks */
      display: none; /* shown only when popup is open */
    }
    .chat-popup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 720px;
      max-width: 98vw;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      z-index: 2000;
      min-height: 360px;
      min-width: 480px;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #e6e6f7;
      border-radius: 16px 16px 0 0;
      font-weight: bold;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-size: 17px;
      min-height: 200px;
    }
    .chat-input-area {
      display: flex;
      border-top: 1px solid #eee;
      padding: 12px;
      background: #fafaff;
    }
    #chatInput {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 17px;
      outline: none;
    }
    #sendChat {
      margin-left: 12px;
      padding: 10px 28px;
      border-radius: 8px;
      border: none;
      background: #b3b3e6;
      color: #fff;
      font-weight: bold;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChat:hover {
      background: #8a8ad6;
    }
    @media (max-width: 600px) {
      .header, .sosci-iframe {
        width: 100vw;
      }
      .spline-chatbot {
        width: 100%;
        height: 100%;
      }
    }
  </style>
  <script>
    if (window.__IS_DESKTOP__) {
      var splineScript = document.createElement('script');
      splineScript.type = 'module';
      splineScript.src = 'https://unpkg.com/@splinetool/viewer@1.10.53/build/spline-viewer.js';
      document.head.appendChild(splineScript);
    }
  </script>
</head>
<body>
  <div class="header">
    <div class="spline-chatbot">
      <spline-viewer 
      id="splineBot" 
      url="https://prod.spline.design/TcP4CdVPfRiOUfmZ/scene.splinecode"
      onload="onSplineLoaded(event)">
    </spline-viewer>    
    </div>
  </div>
  <div id="chatPopup" class="chat-popup" style="display:none;">
    <div class="chat-header">
      <span>What can I do for you?</span>
      <button id="closeChat" class="close-btn">&times;</button>
    </div>
    <div class="chat-messages">
    </div>
    <div class="chat-input-area">
      <input id="chatInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendChat">Send</button>
    </div>
  </div>
  <!-- SoSci Survey ÈóÆÂç∑ -->
  <iframe class="sosci-iframe"></iframe>
  <!-- Overlay to block iframe interactions when chat popup is open -->
  <div id="iframeOverlay" class="iframe-overlay" aria-hidden="true"></div>

  <script>
  if (window.__IS_DESKTOP__) {
  // ===== A/B Group Assignment (50/50, sticky per visitor) =====
  (function () {
    const STORAGE_KEY = "abGroup"; // "exp" or "ctl"

    function readGroupFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        // Prefer abGroup, but also accept legacy/alternate param ab
        let g = params.get("abGroup");
        if (!g) g = params.get("ab");
        if (!g) return null;
        g = String(g).trim().toLowerCase();
        if (g === "exp") return "exp";
        if (g === "ctl") return "ctl";
      } catch {}
      return null;
    }

    function getOrAssignGroup() {
      const urlGroup = readGroupFromUrl();
      if (urlGroup) {
        try { localStorage.setItem(STORAGE_KEY, urlGroup); } catch {}
        return urlGroup;
      }
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved === "exp" || saved === "ctl") return saved;
      } catch {}
      const assigned = Math.random() < 0.5 ? "exp" : "ctl";
      try { localStorage.setItem(STORAGE_KEY, assigned); } catch {}
      return assigned;
    }

    const abGroup = getOrAssignGroup();
    window.__AB_GROUP__ = abGroup; // Expose for debugging

    // UI rules per group
    if (abGroup === "ctl") {
      // Control group: hide Spline, show placeholder with same size and position, keep popup hidden
      const chatPopup = document.getElementById("chatPopup");
      if (chatPopup) chatPopup.style.display = "none";

      const container = document.querySelector(".spline-chatbot");
      const viewer = document.getElementById("splineBot");

      if (viewer) viewer.style.display = "none";
      if (container) {
        const placeholder = document.createElement("div");
        placeholder.setAttribute("id", "splinePlaceholder");
        placeholder.style.width = "100%";
        placeholder.style.height = "100%";
        placeholder.style.background = "rgb(211, 210, 227)";
        placeholder.style.borderRadius = "0";
        placeholder.style.boxShadow = "none";
        container.appendChild(placeholder);
      }
      // Keep header visible to preserve layout height (260px) for parity with experiment group
    }

    // Send group to SoSci in two ways: set URL (q=Test/NoChatnot) and postMessage (for logging)
    const iframe = document.querySelector(".sosci-iframe");
    if (iframe) {
      try {
        const baseHref = "https://www.soscisurvey.de/TestWithsurvey/";
        const url = new URL(baseHref);
        // When page has chatbot (exp): q=Test; when no chatbot (ctl): q=NoChatnot
        url.searchParams.set("q", abGroup === "exp" ? "Test" : "NoChatnot");
        // Send group redundantly via both abGroup and ab for compatibility with SoSci PHP
        url.searchParams.set("abGroup", abGroup);
        url.searchParams.set("ab", abGroup); // using exp/ctl values
        const nextSrc = url.toString();
        if (iframe.src !== nextSrc) {
          iframe.src = nextSrc;
        }
        console.log("üîó SoSci iframe src set to:", nextSrc);
      } catch (e) {
        console.warn("Could not set q/abGroup params on SoSci iframe:", e);
      }

      iframe.addEventListener("load", function () {
        try {
          iframe.contentWindow.postMessage({ type: "abGroup", value: abGroup }, "*");
          console.log("üì§ Sent abGroup to SoSci:", abGroup);
        } catch (e) {
          console.warn("Could not postMessage abGroup to SoSci:", e);
        }
      });
    }

    console.log("üß™ A/B group:", abGroup === "exp" ? "experiment" : "control");
  })();

  // ===== Metrics for popup usage =====
  const popupMetrics = {
    openCount: 0,
    sendCount: 0,
    sendByClickCount: 0,
    sendByEnterCount: 0,
    totalOpenDurationMs: 0,
    lastOpenAtMs: null
  };

  function getSosciIframeWindow() {
    const el = document.querySelector('.sosci-iframe');
    return el && el.contentWindow ? el.contentWindow : null;
  }

  function postMetricsToSosci(eventType, extra = {}) {
    try {
      const target = getSosciIframeWindow();
      if (!target) {
        console.warn('postMetricsToSosci: sosci iframe not ready');
        return;
      }
      const payload = {
        type: eventType,
        metrics: {
          openCount: popupMetrics.openCount,
          sendCount: popupMetrics.sendCount,
          sendByClickCount: popupMetrics.sendByClickCount,
          sendByEnterCount: popupMetrics.sendByEnterCount,
          totalOpenDurationMs: popupMetrics.totalOpenDurationMs
        },
        ...extra
      };
      console.log('üì§ Metrics to SoSci:', payload);
      target.postMessage(payload, '*');
    } catch (e) {
      console.warn('Could not post metrics to SoSci:', e);
    }
  }

  // Expose quick debug helpers
  window.debugPopupMetrics = function() {
    console.log('üß™ popupMetrics snapshot:', JSON.parse(JSON.stringify(popupMetrics)));
    return popupMetrics;
  };

  window.sendSosciDebugPing = function() {
    const target = getSosciIframeWindow();
    if (!target) {
      console.warn('sendSosciDebugPing: sosci iframe not ready');
      return false;
    }
    const payload = { type: 'debugFromParent', now: Date.now() };
    console.log('üì§ Debug ping to SoSci:', payload);
    target.postMessage(payload, '*');
    return true;
  };

  function trackPopupOpen() {
    popupMetrics.openCount += 1;
    popupMetrics.lastOpenAtMs = Date.now();
    postMetricsToSosci('popupOpen');
  }

  function trackPopupClose() {
    if (popupMetrics.lastOpenAtMs) {
      const durationMs = Date.now() - popupMetrics.lastOpenAtMs;
      popupMetrics.totalOpenDurationMs += durationMs;
      popupMetrics.lastOpenAtMs = null;
      postMetricsToSosci('popupClose', { durationMs });
    } else {
      postMetricsToSosci('popupClose');
    }
  }

  function trackPopupSend(method) {
    popupMetrics.sendCount += 1;
    if (method === 'click') popupMetrics.sendByClickCount += 1;
    if (method === 'enter') popupMetrics.sendByEnterCount += 1;
    postMetricsToSosci('popupSend', { method });
  }

  function openChatPopup() {
    const popup = document.getElementById('chatPopup');
    if (!popup) return;
    if (getComputedStyle(popup).display !== 'none') return; // already open
    popup.style.display = 'flex';
    const iframeOverlay = document.getElementById('iframeOverlay');
    if (iframeOverlay) iframeOverlay.style.display = 'block';
    // Metrics: track open
    trackPopupOpen();
  }

  function closeChatPopup() {
    const popup = document.getElementById('chatPopup');
    if (!popup) return;
    popup.style.display = 'none';
    const iframeOverlay = document.getElementById('iframeOverlay');
    if (iframeOverlay) iframeOverlay.style.display = 'none';
    // Metrics: track close + duration
    trackPopupClose();
  }

  

  document.getElementById('splineBot').addEventListener('click', function () {
    openChatPopup();
  });

document.getElementById('splineBot').addEventListener('click', async function () {
  // ‚úÖ ÊØèÊ¨°ÊâìÂºÄ popup Êó∂Âº∫Âà∂Êñ∞Âª∫ Thread
  threadId = null; 
  await createThread();
  console.log("‚úÖ New Thread created:", threadId);

  openChatPopup();
});


  // ‚úÖ Throttle function to limit API calls
  function throttle(func, limit) {
    let lastFunc;
    let lastRan;
    return function (...args) {
      const context = this;
      if (!lastRan) {
        func.apply(context, args);
        lastRan = Date.now();
      } else {
        clearTimeout(lastFunc);
        lastFunc = setTimeout(function () {
          if ((Date.now() - lastRan) >= limit) {
            func.apply(context, args);
            lastRan = Date.now();
          }
        }, limit - (Date.now() - lastRan));
      }
    };
  }

// ‚úÖ Webhook settings (ÊõøÊç¢‰∏∫‰Ω†ÁöÑ Webhook)
const SPLINE_WEBHOOK_URL = "https://hooks.spline.design/hShFzXwoRXU";
const AUTH_KEY = "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA";

// ‚úÖ ÂèëÈÄÅÂà∞ Spline
async function sendToSpline(x, y) {
  try {
    const res = await fetch(SPLINE_WEBHOOK_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": AUTH_KEY,
        "Accept": "application/json"
      },
      body: JSON.stringify({
        targetX: x,
        targetY: y
      })
    });
    if (!res.ok) {
      console.error("Webhook request failed:", res.statusText);
    } else {
      console.log("‚úÖ Webhook sent to Spline:", x, y);
    }
  } catch (error) {
    console.error("‚ùå Error sending to Spline:", error);
  }
}

// ‚úÖ Throttle function (ÂÖ®Â±ÄÂè™ÂàõÂª∫‰∏ÄÊ¨°)
function throttle(func, limit) {
  let lastRun;
  return function (...args) {
    if (!lastRun || Date.now() - lastRun >= limit) {
      func.apply(this, args);
      lastRun = Date.now();
    }
  };
}
const throttledSend = throttle(sendToSpline, 16); // ÊØè 16ms ÊâßË°å‰∏ÄÊ¨°

// ===== Listen to SoSci Messages =====
window.addEventListener("message", function (event) {
  if (!event.data) return;
  console.log("üì© Message from SoSci:", event.data);

  if (event.data.type === "mouseMove") {
    // Convert to global coordinates (important if needed)
    const iframe = document.querySelector(".sosci-iframe");
    const rect = iframe.getBoundingClientRect();
    const globalX = event.data.x + rect.left;
    const globalY = event.data.y + rect.top;

    // Áõ¥Êé•‰ΩøÁî®ÂÖ®Â±ÄÂùêÊ†á
    console.log("üñ± Global Position:", globalX, globalY);
    throttledSend(globalX, globalY);
  }
});

console.log("‚úÖ Parent TooFast Listener Running...");

let lastClickTime = 0;

// ‚úÖ ÁõëÂê¨Êù•Ëá™ SoSci ÁöÑÊ∂àÊÅØ
window.addEventListener("message", async function(event) {
  // ÊâìÂç∞ÊâÄÊúâÊî∂Âà∞ÁöÑÊ∂àÊÅØÔºàË∞ÉËØïÁî®Ôºâ
  console.log("üì© Received message from SoSci:", event.data);

  // Âè™Â§ÑÁêÜ nextClicked Ê∂àÊÅØ
  if (!event.data || event.data.type !== "nextClicked") return;

  const now = Date.now();
  console.log("‚úÖ Parent received: nextClicked at", now);

  if (now - lastClickTime < 10000) { // ‚úÖ Âà§Êñ≠Èó¥ÈöîÊòØÂê¶Â∞è‰∫é10Áßí
    console.log("‚ö° TooFast triggered! Sending Webhook to Spline...");
    await triggerTooFast();
  }

  lastClickTime = now;
});

// ‚úÖ ÂèëÈÄÅ TooFast Webhook Âà∞ Spline
async function triggerTooFast() {
  console.log("‚è© Sending WebhookTooFast to Spline...");

  try {
    const response = await fetch("https://hooks.spline.design/wRpIXhNtx2M", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA",
        "Accept": "application/json"
      },
      body: JSON.stringify({ Fast: "" }) // ‚úÖ ÂèÇÊï∞ÂøÖÈ°ª‰∏éÂõæ‰∏≠ÁöÑWebhooksËÆæÁΩÆ‰∏ÄËá¥
    });

    const text = await response.text();
    console.log("‚úÖ WebhookTooFast Response Status:", response.status);
    console.log("‚úÖ WebhookTooFast Response Text:", text);

    if (response.ok) {
      console.log("‚úÖ WebhookTooFast Â∑≤ÊàêÂäüÂèëÈÄÅÔºÅ");
    } else {
      console.error("‚ùå WebhookTooFast ÂèëÈÄÅÂ§±Ë¥•ÔºÅÁä∂ÊÄÅÁ†ÅÔºö", response.status, text);
    }
  } catch (err) {
    console.error("‚ùå WebhookTooFast ÂèëÈÄÅÂºÇÂ∏∏Ôºö", err);
  }
}

/******************************
 * ‚úÖ OpenAI Assistants Chat Logic (English UI)
 * Put this after all Spline & SoSci code
 ******************************/



// üëâ Replace with your own keys
const ASSISTANT_ID = "asst_87IY5eVsu1vXM4RSr71kykww";  
const OPENAI_PROXY_URL = "https://chatbotsurvey.yuqing.wang"

let threadId = null;        
let questionCount = 0;      
  const MAX_QUESTIONS = 100;   // Limit to 100 questions

// ‚úÖ Create Thread (only once)
async function createThread() {
  const res = await fetch(`${OPENAI_PROXY_URL}/v1/threads`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    }
  });
  const data = await res.json();
  threadId = data.id;
  console.log("‚úÖ Thread created:", threadId);
}

// ‚úÖ Send user message & get reply
async function sendMessageToAssistant(userMessage) {
  if (!threadId) await createThread();
  questionCount++;

  // ‚úÖ Limit check
  if (questionCount > MAX_QUESTIONS) {
    return `‚ö†Ô∏è You have reached the maximum of ${MAX_QUESTIONS} questions. Please continue with the survey.`;
  }

  // 1. Add user message
  await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      role: "user",
      content: userMessage
    })
  });

  // 2. Run Assistant
  const runRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ assistant_id: ASSISTANT_ID })
  });
  const runData = await runRes.json();
  console.log("üöÄ Run started:", runData.id);


  // 3. Poll until completed
  let status = "in_progress";
  while (status === "in_progress" || status === "queued") {
    await new Promise(r => setTimeout(r, 500)); // ÂáèÂ∞ëÂà∞ 500ms
    const checkRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs/${runData.id}`);
    const checkData = await checkRes.json();
    status = checkData.status;
    console.log("‚è≥ Run status:", status);
  }

  // 4. Get reply
  const msgRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`,);
  const messages = await msgRes.json();
  const assistantMessage = messages.data.find(msg => msg.role === "assistant");
  const reply = assistantMessage ? assistantMessage.content[0].text.value : "‚ö†Ô∏è No reply from Assistant.";
  console.log("ü§ñ Assistant reply:", reply);
  return reply;
}

// ‚úÖ Bind popup's Send button (already in your popup)
document.getElementById("sendChat").addEventListener("click", async () => {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>üë§ You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>ü§ñ Bot:</b> ${reply}</div>`;

  chatBox.scrollTop = chatBox.scrollHeight;
  // Metrics: track send by click
  trackPopupSend('click');
});


// ‚úÖ New: Press Enter to send message
document.getElementById("chatInput").addEventListener("keydown", async (event) => {
  if (event.key === "Enter" && !event.shiftKey) { 
    event.preventDefault();  // Prevent adding a new line
    await handleSendMessage();
    // Metrics: track send by enter
    trackPopupSend('enter');
  }
});

// ‚úÖ Extracted sending logic into one function (avoid duplicate code)
async function handleSendMessage() {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>üë§ You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>ü§ñ Bot:</b> ${reply}</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ÂèëÈÄÅ 'Send' Webhook Âà∞ Spline
async function sendWebhookToSpline() {
  try {
    const response = await fetch('https://hooks.spline.design/IxDJ6RlBwGQ', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': '35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 'Send': '' })
    });

    if (!response.ok) {
      console.error('‚ùå Webhook Send failed:', response.statusText);
    } else {
      console.log('‚úÖ Webhook Send successfully sent to Spline');
    }
  } catch (error) {
    console.error('‚ùå Error sending Webhook Send to Spline:', error);
  }
}

// ÁªëÂÆö Send ÊåâÈíÆÔºà‰øùÁïôÂéüÊúâ WebhookÔºåÂêàÂπ∂ËÆ°Êï∞Ôºâ
const sendButton = document.getElementById('sendChat');
sendButton.addEventListener('click', async () => {
  await sendWebhookToSpline();
});

document.getElementById('closeChat').addEventListener('click', function () {
  closeChatPopup();
});

let robot = null;
let mouseX = 0, mouseY = 0;

function waitForSpline() {
  const splineViewer = document.getElementById('splineBot');

  if (!splineViewer) {
    console.log("‚ùå Ê≤°ÊâæÂà∞ spline-viewer ÂÖÉÁ¥†");
    setTimeout(waitForSpline, 500);
    return;
  }

  if (splineViewer.spline) {
    const splineApp = splineViewer.spline;
    robot = splineApp.findObjectByName('Robot');
    console.log("‚úÖ ÊâæÂà∞ÁöÑÂØπË±°Ôºö", robot);
    if (robot) {
      animateLookAt(splineApp.THREE);
    } else {
      console.log("‚ùå Ê≤°ÊúâÊâæÂà∞Âêç‰∏∫ Robot ÁöÑÂØπË±°ÔºåËØ∑Ê£ÄÊü•ÂêçÂ≠ó");
    }
  } else {
    console.log("‚è≥ Á≠âÂæÖ Spline Âä†ËΩΩ‰∏≠...");
    setTimeout(waitForSpline, 500);
  }
}

// ‚úÖ ÂêØÂä®ËΩÆËØ¢
waitForSpline();

function animateLookAt(THREE) {
  function loop() {
    if (robot) {
      const target = new THREE.Vector3(mouseX / 10, -mouseY / 10, 0);
      robot.lookAt(target);
    }
    requestAnimationFrame(loop);
  }
  loop();
}

// ‚úÖ SoSci Èº†Ê†áÁõëÂê¨‰øùÊåÅ‰∏çÂèò
window.addEventListener("message", function (event) {
  if (!event.data || event.data.type !== "mouseMove") return;
  const iframe = document.querySelector(".sosci-iframe");
  const rect = iframe.getBoundingClientRect();
  mouseX = event.data.x + rect.left;
  mouseY = event.data.y + rect.top;
});


window.addEventListener("message", function(event) {
  if (event.data?.type === "questionChange") {
    const questionId = event.data.questionId;
    console.log("‚úÖ Received questionChange:", questionId);

    // Only send webhook for specific questions
    const validIds = ["A101", "A109", "A203", "A404", "A604"];
    if (validIds.includes(questionId)) {
      sendSplineWebhook(questionId);
    }
  }
});

function sendSplineWebhook(questionId) {
  switch (questionId) {
    case "A101":
      fetch("https://hooks.spline.design/FUxKtlrS6bU", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A101": "" })
      })
      .then(() => console.log("üì° Webhook sent: A101"))
      .catch(err => console.error("‚ùå A101 webhook failed:", err));
      break;

    case "A109":
      fetch("https://hooks.spline.design/qQ_kyKk6gdk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A109": "" })
      })
      .then(() => console.log("üì° Webhook sent: A109"))
      .catch(err => console.error("‚ùå A109 webhook failed:", err));
      break;

    case "A203":
      fetch("https://hooks.spline.design/vWQWEibHcqw", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A203": "" })
      })
      .then(() => console.log("üì° Webhook sent: A203"))
      .catch(err => console.error("‚ùå A203 webhook failed:", err));
      break;

    case "A404":
      fetch("https://hooks.spline.design/XiidigihE4U", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A404": "" })
      })
      .then(() => console.log("üì° Webhook sent: A404"))
      .catch(err => console.error("‚ùå A404 webhook failed:", err));
      break;

    case "A604":
      fetch("https://hooks.spline.design/mPAI0ZeEE2g", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A604": "" })
      })
      .then(() => console.log("üì° Webhook sent: A604"))
      .catch(err => console.error("‚ùå A604 webhook failed:", err));
      break;

    default:
      console.log("‚ö†Ô∏è No webhook defined for:", questionId);
  }
}

const iframe = document.querySelector('.sosci-iframe');

// ËØ∑Ê±Ç iframe ÂèëÈÄÅ ABGROUP ÂÄº
iframe.onload = function () {
  iframe.contentWindow.postMessage("getABGroup", "*");
};

// ÁõëÂê¨ iframe ËøîÂõû
window.addEventListener("message", function (event) {
  if (event.data?.type === "abGroupValue") {
    console.log("üì© Received ABGROUP from SoSci:", event.data.value);
  }
});
  }
</script>



</body>
</html> 