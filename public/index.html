<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Chatbot + SoSci Survey</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #fff;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .header {
      width: 100vw;
      height: 260px;
      background: none;
      padding: 0;
      margin: 0;
      position: relative;
    }
    .spline-chatbot {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: none;
      box-shadow: none;
      border-radius: 0;
      display: block;
    }
    .sosci-iframe {
      width: 100vw;
      height: calc(100vh - 260px);
      border: none;
      display: block;
    }
    .chat-popup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 720px;
      max-width: 98vw;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      z-index: 2000;
      min-height: 360px;
      min-width: 480px;
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #e6e6f7;
      border-radius: 16px 16px 0 0;
      font-weight: bold;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      font-size: 17px;
      min-height: 200px;
    }
    .chat-input-area {
      display: flex;
      border-top: 1px solid #eee;
      padding: 12px;
      background: #fafaff;
    }
    #chatInput {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 17px;
      outline: none;
    }
    #sendChat {
      margin-left: 12px;
      padding: 10px 28px;
      border-radius: 8px;
      border: none;
      background: #b3b3e6;
      color: #fff;
      font-weight: bold;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sendChat:hover {
      background: #8a8ad6;
    }
    @media (max-width: 600px) {
      .header, .sosci-iframe {
        width: 100vw;
      }
      .spline-chatbot {
        width: 100%;
        height: 100%;
      }
    }
  </style>
  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.10.44/build/spline-viewer.js"></script>
</head>
<body>
  <div class="header">
    <div class="spline-chatbot">
      <spline-viewer 
      id="splineBot" 
      url="https://prod.spline.design/TcP4CdVPfRiOUfmZ/scene.splinecode"
      onload="onSplineLoaded(event)">
    </spline-viewer>    
    </div>
  </div>
  <div id="chatPopup" class="chat-popup" style="display:none;">
    <div class="chat-header">
      <span>What can I do for you?</span>
      <button id="closeChat" class="close-btn">&times;</button>
    </div>
    <div class="chat-messages">
    </div>
    <div class="chat-input-area">
      <input id="chatInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendChat">Send</button>
    </div>
  </div>
  <!-- SoSci Survey 问卷 -->
  <iframe class="sosci-iframe" src="https://www.soscisurvey.de/TestWithsurvey/?q=Test"></iframe>

  <script>
  document.getElementById('splineBot').addEventListener('click', function () {
    document.getElementById('chatPopup').style.display = 'flex';
  });

document.getElementById('splineBot').addEventListener('click', async function () {
  // ✅ 每次打开 popup 时强制新建 Thread
  threadId = null; 
  await createThread();
  console.log("✅ New Thread created:", threadId);

  document.getElementById('chatPopup').style.display = 'flex';
});


  // ✅ Throttle function to limit API calls
  function throttle(func, limit) {
    let lastFunc;
    let lastRan;
    return function (...args) {
      const context = this;
      if (!lastRan) {
        func.apply(context, args);
        lastRan = Date.now();
      } else {
        clearTimeout(lastFunc);
        lastFunc = setTimeout(function () {
          if ((Date.now() - lastRan) >= limit) {
            func.apply(context, args);
            lastRan = Date.now();
          }
        }, limit - (Date.now() - lastRan));
      }
    };
  }

// ✅ Webhook settings (替换为你的 Webhook)
const SPLINE_WEBHOOK_URL = "https://hooks.spline.design/hShFzXwoRXU";
const AUTH_KEY = "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA";

// ✅ 发送到 Spline
async function sendToSpline(x, y) {
  try {
    const res = await fetch(SPLINE_WEBHOOK_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": AUTH_KEY,
        "Accept": "application/json"
      },
      body: JSON.stringify({
        targetX: x,
        targetY: y
      })
    });
    if (!res.ok) {
      console.error("Webhook request failed:", res.statusText);
    } else {
      console.log("✅ Webhook sent to Spline:", x, y);
    }
  } catch (error) {
    console.error("❌ Error sending to Spline:", error);
  }
}

// ✅ Throttle function (全局只创建一次)
function throttle(func, limit) {
  let lastRun;
  return function (...args) {
    if (!lastRun || Date.now() - lastRun >= limit) {
      func.apply(this, args);
      lastRun = Date.now();
    }
  };
}
const throttledSend = throttle(sendToSpline, 16); // 每 16ms 执行一次

// ===== Listen to SoSci Messages =====
window.addEventListener("message", function (event) {
  if (!event.data) return;
  console.log("📩 Message from SoSci:", event.data);

  if (event.data.type === "mouseMove") {
    // Convert to global coordinates (important if needed)
    const iframe = document.querySelector(".sosci-iframe");
    const rect = iframe.getBoundingClientRect();
    const globalX = event.data.x + rect.left;
    const globalY = event.data.y + rect.top;

    // 直接使用全局坐标
    console.log("🖱 Global Position:", globalX, globalY);
    throttledSend(globalX, globalY);
  }
});

console.log("✅ Parent TooFast Listener Running...");

let lastClickTime = 0;

// ✅ 监听来自 SoSci 的消息
window.addEventListener("message", async function(event) {
  // 打印所有收到的消息（调试用）
  console.log("📩 Received message from SoSci:", event.data);

  // 只处理 nextClicked 消息
  if (!event.data || event.data.type !== "nextClicked") return;

  const now = Date.now();
  console.log("✅ Parent received: nextClicked at", now);

  if (now - lastClickTime < 10000) { // ✅ 判断间隔是否小于10秒
    console.log("⚡ TooFast triggered! Sending Webhook to Spline...");
    await triggerTooFast();
  }

  lastClickTime = now;
});

// ✅ 发送 TooFast Webhook 到 Spline
async function triggerTooFast() {
  console.log("⏩ Sending WebhookTooFast to Spline...");

  try {
    const response = await fetch("https://hooks.spline.design/wRpIXhNtx2M", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA",
        "Accept": "application/json"
      },
      body: JSON.stringify({ Fast: "" }) // ✅ 参数必须与图中的Webhooks设置一致
    });

    const text = await response.text();
    console.log("✅ WebhookTooFast Response Status:", response.status);
    console.log("✅ WebhookTooFast Response Text:", text);

    if (response.ok) {
      console.log("✅ WebhookTooFast 已成功发送！");
    } else {
      console.error("❌ WebhookTooFast 发送失败！状态码：", response.status, text);
    }
  } catch (err) {
    console.error("❌ WebhookTooFast 发送异常：", err);
  }
}

/******************************
 * ✅ OpenAI Assistants Chat Logic (English UI)
 * Put this after all Spline & SoSci code
 ******************************/



// 👉 Replace with your own keys
const ASSISTANT_ID = "asst_87IY5eVsu1vXM4RSr71kykww";  
const OPENAI_PROXY_URL = "https://chatbotsurvey.yuqing.wang"

let threadId = null;        
let questionCount = 0;      
const MAX_QUESTIONS = 20;   // Limit to 20 questions

// ✅ Create Thread (only once)
async function createThread() {
  const res = await fetch(`${OPENAI_PROXY_URL}/v1/threads`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    }
  });
  const data = await res.json();
  threadId = data.id;
  console.log("✅ Thread created:", threadId);
}

// ✅ Send user message & get reply
async function sendMessageToAssistant(userMessage) {
  if (!threadId) await createThread();
  questionCount++;

  // ✅ Limit check
  if (questionCount > MAX_QUESTIONS) {
    return "⚠️ You have reached the maximum of 20 questions. Please continue with the survey.";
  }

  // 1. Add user message
  await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      role: "user",
      content: userMessage
    })
  });

  // 2. Run Assistant
  const runRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ assistant_id: ASSISTANT_ID })
  });
  const runData = await runRes.json();
  console.log("🚀 Run started:", runData.id);


  // 3. Poll until completed
  let status = "in_progress";
  while (status === "in_progress" || status === "queued") {
    await new Promise(r => setTimeout(r, 500)); // 减少到 500ms
    const checkRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/runs/${runData.id}`);
    const checkData = await checkRes.json();
    status = checkData.status;
    console.log("⏳ Run status:", status);
  }

  // 4. Get reply
  const msgRes = await fetch(`${OPENAI_PROXY_URL}/v1/threads/${threadId}/messages`,);
  const messages = await msgRes.json();
  const assistantMessage = messages.data.find(msg => msg.role === "assistant");
  const reply = assistantMessage ? assistantMessage.content[0].text.value : "⚠️ No reply from Assistant.";
  console.log("🤖 Assistant reply:", reply);
  return reply;
}

// ✅ Bind popup's Send button (already in your popup)
document.getElementById("sendChat").addEventListener("click", async () => {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>👤 You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>🤖 Bot:</b> ${reply}</div>`;

  chatBox.scrollTop = chatBox.scrollHeight;
});


// ✅ New: Press Enter to send message
document.getElementById("chatInput").addEventListener("keydown", async (event) => {
  if (event.key === "Enter" && !event.shiftKey) { 
    event.preventDefault();  // Prevent adding a new line
    await handleSendMessage();
  }
});

// ✅ Extracted sending logic into one function (avoid duplicate code)
async function handleSendMessage() {
  const inputEl = document.getElementById("chatInput");
  const userText = inputEl.value.trim();
  if (!userText) return;

  const chatBox = document.querySelector(".chat-messages");
  chatBox.innerHTML += `<div><b>👤 You:</b> ${userText}</div>`;
  inputEl.value = "";

  const reply = await sendMessageToAssistant(userText);
  chatBox.innerHTML += `<div><b>🤖 Bot:</b> ${reply}</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;
}

// 发送 'Send' Webhook 到 Spline
async function sendWebhookToSpline() {
  try {
    const response = await fetch('https://hooks.spline.design/IxDJ6RlBwGQ', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': '35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 'Send': '' })
    });

    if (!response.ok) {
      console.error('❌ Webhook Send failed:', response.statusText);
    } else {
      console.log('✅ Webhook Send successfully sent to Spline');
    }
  } catch (error) {
    console.error('❌ Error sending Webhook Send to Spline:', error);
  }
}

// 绑定 Send 按钮
const sendButton = document.getElementById('sendChat');
sendButton.addEventListener('click', async () => {
  await sendWebhookToSpline();
  // 其他发送逻辑...
});

document.getElementById('closeChat').addEventListener('click', function () {
  document.getElementById('chatPopup').style.display = 'none';
});

let robot = null;
let mouseX = 0, mouseY = 0;

function waitForSpline() {
  const splineViewer = document.getElementById('splineBot');

  if (!splineViewer) {
    console.log("❌ 没找到 spline-viewer 元素");
    setTimeout(waitForSpline, 500);
    return;
  }

  if (splineViewer.spline) {
    const splineApp = splineViewer.spline;
    robot = splineApp.findObjectByName('Robot');
    console.log("✅ 找到的对象：", robot);
    if (robot) {
      animateLookAt(splineApp.THREE);
    } else {
      console.log("❌ 没有找到名为 Robot 的对象，请检查名字");
    }
  } else {
    console.log("⏳ 等待 Spline 加载中...");
    setTimeout(waitForSpline, 500);
  }
}

// ✅ 启动轮询
waitForSpline();

function animateLookAt(THREE) {
  function loop() {
    if (robot) {
      const target = new THREE.Vector3(mouseX / 10, -mouseY / 10, 0);
      robot.lookAt(target);
    }
    requestAnimationFrame(loop);
  }
  loop();
}

// ✅ SoSci 鼠标监听保持不变
window.addEventListener("message", function (event) {
  if (!event.data || event.data.type !== "mouseMove") return;
  const iframe = document.querySelector(".sosci-iframe");
  const rect = iframe.getBoundingClientRect();
  mouseX = event.data.x + rect.left;
  mouseY = event.data.y + rect.top;
});


window.addEventListener("message", function(event) {
  if (event.data?.type === "questionChange") {
    const questionId = event.data.questionId;
    console.log("✅ Received questionChange:", questionId);

    // Only send webhook for specific questions
    const validIds = ["A101", "A109", "A203", "A404", "A604"];
    if (validIds.includes(questionId)) {
      sendSplineWebhook(questionId);
    }
  }
});

function sendSplineWebhook(questionId) {
  switch (questionId) {
    case "A101":
      fetch("https://hooks.spline.design/FUxKtlrS6bU", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A101": "" })
      })
      .then(() => console.log("📡 Webhook sent: A101"))
      .catch(err => console.error("❌ A101 webhook failed:", err));
      break;

    case "A109":
      fetch("https://hooks.spline.design/qQ_kyKk6gdk", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A109": "" })
      })
      .then(() => console.log("📡 Webhook sent: A109"))
      .catch(err => console.error("❌ A109 webhook failed:", err));
      break;

    case "A203":
      fetch("https://hooks.spline.design/vWQWEibHcqw", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A203": "" })
      })
      .then(() => console.log("📡 Webhook sent: A203"))
      .catch(err => console.error("❌ A203 webhook failed:", err));
      break;

    case "A404":
      fetch("https://hooks.spline.design/XiidigihE4U", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A404": "" })
      })
      .then(() => console.log("📡 Webhook sent: A404"))
      .catch(err => console.error("❌ A404 webhook failed:", err));
      break;

    case "A604":
      fetch("https://hooks.spline.design/mPAI0ZeEE2g", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "35H7FCbmOGzhNgGhWmEk3nseXj0FD6vovEP-XNK8nZA"
        },
        body: JSON.stringify({ "A604": "" })
      })
      .then(() => console.log("📡 Webhook sent: A604"))
      .catch(err => console.error("❌ A604 webhook failed:", err));
      break;

    default:
      console.log("⚠️ No webhook defined for:", questionId);
  }
}


</script>


</body>
</html> 